\subsection{CTS conversion from \source to \target}
\label{sec:transformation}

\input{differentiation-and-static-caching}

CTS conversion from $\source$ to $\target$ is
defined in Figure~\ref{fig:differentiation-and-static-caching}. It comprises
CTS differentiation $\mathcal{D}{(\param)}$, from
$\source$ base terms to $\target$ change terms,
and CTS translation $\mathcal{C}(\param)$, from $\source$
$\target$, which is overloaded over top-level
definitions~$\compile{\tf = \slam{\tx}{\sterm}}$ and
terms~$\compileterm{\tcache}{\sterm}$.

By the first rule, $\compile{\param}$ maps each source toplevel definition
``$\tf = \slam{\tx}{\sterm}$'' to the compiled code of the
function $\tf$ and to the derivative~$\tdf$ of~$\tf$ expressed in the
target language~$\target$. These target definitions are generated by a
first call to the compilation function~$\compileterm{\tcachecons\temptycache\tx}{\sterm}$:
it returns both~$\tterm$, the compiled body of $\tf$ and the
cache term~$\tcache$ which contains the names of the intermediate
values computed by the evaluation of $\tterm$. This cache
term~$\tcache$ is used as a cache pattern to define the second
argument of the derivative of $\tf$. That way, we make sure that the
shape of the cache expected by $\tdf$ is consistent with the shape of
the cache produced by $\tf$. Derivative body~$\tdf$ is
computed by derivation call~$\derive{(\tx \oplus \tdx)}{\sterm}$.

CTS translation on terms, $\compileterm{\tcache}{\sterm}$, accepts a term
$\sterm$ and a cache term
$\tcache$. This cache is a fragment of output code: in tail
position ($\sterm = \tx$), it
generates code to return both the result $\tx$ and the cache $\tcache$. When the
transformation visits {\bf let}-bindings, it outputs extra bindings for
caches~$\tcacheid\ty\tf\tx$, and appends all variables newly bound in the output
to the cache used when visiting the {\bf let}-body.

Similarly to $\compileterm{\tcache}{\sterm}$, CTS
derivation~$\derive{\tupdcache}{\sterm}$ accepts a cache update
$\tupdcache$ to return in tail position. While cache terms record \emph{intermediate
results}, cache updates record \emph{result updates}. For {\bf let}-bindings,
to update $\ty$ by change $\tdy$, CTS derivation appends
to $\tupdcache$ term $\ty \oplus \tdy$ to replace $\ty$.

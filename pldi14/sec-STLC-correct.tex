% Emacs, this is -*- latex -*-!
\section{Correctness proof of derivation on simply typed lambda
  terms}
\label{sec:STLC-correct}

\yc{claim correspondence to Agda script}
\pg{Lots of this should move to earlier in the paper, and should not be repeated here. Remember to update this section.}
Let $\GD\Gs$ be the type of changes to values of type $\Gs$. Let
us specify $\GD\Gs$ recursively thus:
\begin{align*}
\GD(\Gs\r\Gt)&=\Gs \r \GD\Gs \r \GD\Gt,\\
\GD\Gi&=\Gi.
\end{align*}
Intuitively, the change to a function is a function computing
changes on the result values, and the change to an individual is
its replacement.
We chose the type of changes $\GD\Gi$ to an individual for
simplicity of presentation; its triviality does not hide the
technical issues associated with derivatives.

As seen before \yc{link to justification},
the derivative of a function of type $(\Gs\r\Gt)$ has the type
$\GD(\Gs\r\Gt)=\Gs\r\GD\Gs\r\GD\Gt$.
Let $\Derive{\cdot}$ be the program transformation that produces
derivatives from terms. Below is the most obvious
\pg{I do not like ``obvious'' here} type-correct
implementation.
\begin{align*}
\Derive{\Lit{k_n}}     & = \Lit{k_n}\\
\Derive{\Var{x^\Gs}}   & = \Var{\D x^{\GD\Gs}}\\
\Derive{\App{s}{t}}    & = \App{\App{\Derive{s}}{t}}{\Derive{t}}\\
\Derive{\Lam{x^\Gs}{t}}& = \Lam{x^\Gs}{\Lam{\D x^{\GD\Gs}}{\Derive{t}}}
\end{align*}
Here $\D x^{\GD\Gs}$ is a fresh variable chosen deterministically
according to $x^{\Gs}$. Henceforth the deterministic choice of
$\D x^{\GD\Gs}$ will be taken for granted.

The most obvious program transformation turns out to be the
correct one.

\begin{theorem}
\label{thm:STLC-correct}
Let $s$ be a closed term of type $(\Gs\r\Gt)$, let $t_0,t_1$ be
closed terms of type $\Gs$, and let $\D t$ be a closed term of
type $\GD\Gs$ denoting the change from $t_0$ to $t_1$. Then we
can obtain the new result $\App* s {t_1}$ by applying the change
$\App*{\App{\Derive s}{t_0}}{\D t}$ to the old result
$\App* s {t_0}$.
\end{theorem}

We need the concepts of difference and change application in
order to make theorem~\ref{thm:STLC-correct} precise and
eventually to prove it.

\begin{definition}
\label{def:diff+apply}
Suppose $u,v\in D_\Gs$ and $\D v\in D_{\GD\Gs}$. Write
$\Diff u v$ for the change from $v$ to $u$, and write
$\Apply{\D v}v$ for the result of applying the change $\D v$ to
the value $v$. The operators $\DIFF$ and $\APPLY$ are defined
recursively as follows, over all $w\in D_{\Gt}$ and
$\D w\in D_{\GD\Gt}$:
\begin{align*}
\Diff u v &= u
&&\text{if}& \Gs&=\Gi\\
\Diff* u v(w)(\D w) &= \Diff{u(\Apply{\D w}w)}{v(w)}
&&\text{if}& \Gs&=(\Gt\r\Gt')\\
\Apply{\D v}v &= \D v
&&\text{if}& \Gs&=\Gi\\
\Apply*{\D v}v(w) &= \Apply{\D v(w)(\Diff w w)}{v(w)}
&&\text{if}& \Gs&=(\Gt\r\Gt')\\
\end{align*}
\end{definition}

With the symbols $\DIFF$ and $\APPLY$, the conclusion of
theorem~\ref{thm:STLC-correct} may be stated succinctly thus:
\[
\mean{\App s {t_1}} =
\Apply{\mean{\App{\App{\Derive s}{t_0}}{\D t}}}
      {\mean{\App s {t_0}}}.
\]
It will be proved via a logical relation that we shall call the
validity of changes.

\begin{definition}[validity of changes]
\label{def:valid-changes}
~ % to push the bullets down
\begin{itemize}
\item Every individual in $D_\Gi$ is a valid change to every
other individual in $D_\Gi$.
\item A function $\D f\in D_{\Gs\r\GD\Gs\r\GD\Gt}$ is a valid
change to the function $f\in D_{\Gs\r\Gt}$ if for every value
$v\in D_\Gs$ and every change $\D v$ valid to $v$,
\begin{enumerate}[(1)]
\item the result $\D f(v)(\D v)$ is a valid change to $f(v)$, and
\item we have
\[
\Apply*{\D f}f \Apply*{\D v}v = \Apply{\D f(v)(\D v)}{f(v)}.
\]
\end{enumerate}
\end{itemize}
\end{definition}

\begin{lemma}
\label{lem:apply-diff}
$
u = \Apply{\Diff* u v}v
$
for all $u,v\in D_\Gs$.
\end{lemma}

\begin{proof}
By induction on the type $\Gs$.

\Case \Gs = \Gi:
By definition
$
  \Apply{\Diff* u v}v
= \Apply uv
= u
$.

\Case \Gs = \Gt \r \Gt': Choose arbitrary $w\in D_\Gt$. Induction
hypothesis on $\Gt$ and $\Gt'$ gives us
\begin{align*}
w    & = \Apply{\Diff* w w}w,\\
v(w) & = \Apply{\Diff*{u(w)}{v(w)}}{v(w)}.
\end{align*}
As a result,
\begin{align*}
\Apply*{\Diff* u v}v(w)
& = \Apply{\Diff*{u(\Apply{\Diff*ww}w)}{v(w)}}{v(w)}\\
& = \Apply{\Diff*{u(w)}{v(w)}}{v(w)}\\
& = u(w).
\end{align*}
Since $w$ is chosen arbitrarily, $\Apply{\Diff* u v}v$ and
$u$ are equal as functions.
\end{proof}

\begin{lemma}
\label{lem:diff-is-valid}
$\Diff* u v$ is a valid change to $v$ for all $u,v\in D_\Gs$.
\end{lemma}

\begin{proof}
By induction on the type $\Gs$.

\Case \Gs = \Gi: Every individual is a valid change to every
other individual.

\Case \Gs = \Gt \r \Gt': Let $w$ be an arbitrary element in
$D_\Gt$ and let $\D w$ be a valid change to $w$. By induction
hypothesis on $\Gt'$,
\[
\Diff* u v(w)(\D w) = \Diff{u(\Apply{\D w}w)}{v(w)}
\]
is a valid change to $v(w)$, fulfilling condition~(1) of the
validity of $\Diff*uv$ as a change to $v$. By
lemma~\ref{lem:apply-diff},
\begin{align*}
u & = \Apply{\Diff*uv}v,\\
u(\Apply{\D w}w)
& = \Apply{\Diff*{u(\Apply{\D w}w)}{v(w)}}{v(w)}.
\end{align*}
They give us
\begin{align*}
    \Apply*{\Diff*uv}v(\Apply{\D w}w)
& = u(\Apply{\D w}w)\\
& = \Apply{\Diff*{u(\Apply{\D w}w)}{v(w)}}{v(w)}\\
& = \Apply{\Diff*uv(w)(\D w)}{v(w)},
\end{align*}
which is precisely condition~(2) of the validity of
$\Diff*uv$ as a change to $v$.
\end{proof}

\begin{definition}
\label{def:consistent-env}
An environment $\Gr$ is consistent if for every variable $x^\Gs$,
the value $\Gr(\D x^{\GD\Gs})$ (with the name $\D x^{\GD\Gs}$
chosen as in $\DERIVE$) is a valid change to $\Gr(x^\Gs)$.
\end{definition}

\begin{definition}[updated environment]
\label{def:updated-env}
If $\Gr$ is a consistent environment, its updated version $\Gr'$
is obtained by setting
\[
\Gr'(x^\Gs) = \Apply{\Gr(\D x^{\GD\Gs})}{\Gr(x^\Gs)}
\]
over all variables $x^\Gs$.
\end{definition}

\begin{lemma}
\label{lem:STLC-valid-correct}
Let $t$ be a term of type $\Gs$, let $\Gr$ be a consistent
environment and let $\Gr'$ be the updated version of $\Gr$.
\begin{enumerate}[(1)]
\item
$\mean*[\Gr]{\Derive t}$ is a valid change to $\mean*[\Gr]t$.
\item
$
\mean[\Gr']t = \Apply{\mean*[\Gr]{\Derive t}}{\mean*[\Gr]t}
$.
\end{enumerate}
\end{lemma}

\begin{proof}
By induction on term structure of $t$.
% In fact we induce on typing judgements.

\Case t = \Lit{k_n}:
Both parts of the lemma are obvious.

\Case t = \Var{x^\Gs}:
We have $\Derive{x^\Gs}=\D x^{\GD\Gs}$. Part~(1) of the lemma
follows from consistency of $\Gr$ and part~(2) from the
definition of updated environments.

\Case t = \App{s_0}{s_1}:
\[
\Derive{t}=\App{\App{\Derive{s_0}}{s_1}}{\Derive{s_1}}.
\]
To avoid clutter, let us write:
\begin{align*}
  f  & = \mean[\Gr]{s_0} &
  f' & = \mean[\Gr']{s_0} &
\D f & = \mean[\Gr]{\Derive{s_0}}\\
  v  & = \mean[\Gr]{s_1} &
  v' & = \mean[\Gr]{s_1} &
\D v & = \mean[\Gr]{\Derive{s_1}}.
\end{align*}
Then
\[
\mean[\Gr]{\Derive{t}} = \D f(v)(\D v).
\]
By induction hypothesis, $\D f$ is a valid change to $f$, and $\D
v$ is a valid change to $v$. By the definition of validity of
changes, $\D f(v)(\D v)$ is a valid change to $f(v)$ and part~(1)
holds. For part~(2), observe that the induction hypothesis on
$s_0$ and $s_1$ gives us
\begin{align*}
f' &= \Apply{\D f}{f},&
v' &= \Apply{\D v}{v}.
\end{align*}
By validity of $\D f$ to $f$:
\begin{align*}
\mean[\Gr']{t}
& = f'(v') \\
& = (\Apply{\D f}f)(\Apply{\D v}{v}) \\
& = \Apply{\D f(v)(\D v)}{f(v)} \\
& = \Apply{\mean*[\Gr]{\Derive t}}{\mean*[\Gr]t}.
\end{align*}

\Case t = \Lam{x} s:%
Suppose $\Gs\r\Gt$ is the type of $t$. Choose arbitrary $v\in
D_\Gs$ and let $\D v$ be a valid change to $v$. Define these
shorthands:
\begin{align*}
f     & = \mean[\Gr]{\Lam{x} s} \\
\D f  & = \mean[\Gr]{\Lam{x}{\Lam{\D x}{\Derive s}}} \\
v'    & = \Apply{\D v}v,\\
\Gr_1 & = \Gr[x\mapsto v,\D x\mapsto\D v]
\end{align*}
Then
\begin{align*}
\D f(v')(\Diff{v'}{v'})
& = \mean[\Gr[x\mapsto v',\D x\mapsto\Diff{v'}{v'}]]{\Derive
s},\\
f(v')
& = \mean[\Gr[x\mapsto v']]s,
\end{align*}
and by induction hypothesis on $s$ and lemma~\ref{lem:apply-diff},
\begin{align*}
(\Apply{\D f}f)(\Apply{\D v}v)
& = (\Apply{\D f}f)(v')\\
& = \Apply{\D f(v')(\Diff{v'}{v'})}{f(v')}\\
& = \mean[\Gr'[x\mapsto\Apply{\Diff*{v'}{v'}}{v'}]]{s}\\
& = \mean[\Gr'[x\mapsto\Apply{\D v}{v}]]s\\
& = \Apply{\mean*[\Gr_1]{\Derive s}}
          {\mean*[\Gr_1]s}\\
& = \Apply{\D f(v)(\D v)}{f(v)}.
\end{align*}
Together with the validity of $\D f(v)(\D v)$ as a change to
$f(v)$ given by the induction hypothesis on $s$, we obtain
part~(1) of the lemma on $t$.

For part~(2), let
\begin{align*}
\Gr_2  & = \Gr[x\mapsto v,\D x\mapsto \Diff vv],\\
\Gr_2' & = \Gr'[x\mapsto v',\D x\mapsto \Diff{v'}{v'}].
\end{align*}
It is clear that $\Gr_2'$ is the updated version of $\Gr_2$. By
induction hypothesis on $s$,
\begin{align*}
\mean*[\Gr']t(v)
& = \mean[\Gr_2']s\\
& = \Apply{\mean*[\Gr_2]{\Derive s}}{\mean*[\Gr_2]s}\\
& = \Apply{\D f(v)(\Diff vv)}{f(v)}\\
& = \Apply*{\mean*[\Gr]{\Derive t}}{\mean*[\Gr]t}(v).
\end{align*}
Since $v$ is arbitrary, $\mean*[\Gr']t$ and
$\Apply*{\mean*[\Gr]{\Derive t}}{\mean*[\Gr]t}$ are equal as
functions.
\end{proof}

We are ready to prove theorem~\ref{thm:STLC-correct}. Let us
restate it precisely.

\begin{theorem}[restatement of theorem~\ref{thm:STLC-correct}]
Let $s$ be a closed term of type $(\Gs\r\Gt)$, let $t_0,t_1$ be
closed terms of type $\Gs$, and let $\D t$ be a closed term
such that
\[
\mean{\D t} = \Diff{\mean{t_1}}{\mean{t_0}}.
\]
Then
\[
\mean{\App s {t_1}} =
\Apply{\mean{\App{\App{\Derive s}{t_0}}{\D t}}}
      {\mean{\App s {t_0}}}.
\]
\end{theorem}

\begin{proof}
Since the denotation of closed terms does not depend on the
environment, we may apply lemma~\ref{lem:STLC-valid-correct} on
any consistent environment. By lemma~\ref{lem:diff-is-valid}, it
is easy to construct (mathematically) a consistent environment.
Then lemma~\ref{lem:STLC-valid-correct} gives us the validity of
$\mean{\Derive s}$ as a change to $\mean s$, and
lemma~\ref{lem:diff-is-valid} gives us the validity of $\mean{\D
t}$ as a change to $\mean{t_0}$. The second condition in the
definition of valid changes on the type $(\Gs\r\Gt)$ gives us
\[
\Apply*{\mean{\Derive s}}{\mean s}(\mean{t_1})
=
\Apply{\mean{\App{\App{\Derive s}{t_0}}{\D t}}}
      {\mean{\App s {t_0}}}.
\]
But
\[
\Apply{\mean{\Derive s}}{\mean s} = \mean s,
\]
for the denotation of $s$ is independent of the environment, no
matter whether they are updated or not. The desired equation
follows.
\end{proof}

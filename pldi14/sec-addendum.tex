\section{Change equivalence}
\label{sec:change-eq}

\pg{restructure; incorporating this section in main body.}
While preparing the final version of the paper~\citep{CaiEtAl2014ILC}, we introduced a
small technical mistake: in \cref{thm:deriv-nil}, we assert that
two changes are equal, even though in
\cref{ssec:change-structures} we promised that ``Throughout
our theory, we only discuss equality of base values, not of
changes.''

However, by that time, we had formalized in Agda the correct
equivalence relation to use on change, that we call change
equivalence. Intuitively, two changes are
\emph{change-equivalent} if using them as changes gives the same
observations, as long as we only observe base values and not
changes themselves; below we show the theorems that we have
proved in Agda and that substantiate this intuition, at least to
a great extent. When it is clear we are talking about changes, we
will also say that two changes are equivalent to mean that they
are change-equivalent.

In this section, we
state the corrected version of \cref{thm:deriv-nil}, and explain
what we know about this change equivalence.

\begin{definition}[Change equivalence]
  Given a change structure $\ChangeStruct{V}$, a value $v \in V$,
  and two changes $\D v_1, \D v_2 \in \Change{v}$, if and only if
  $\Update{v}{\D v_1} = \Update{v}{\D v_2}$ we say that $\D v_1$
  is change-equivalent to $\D v_2$, and
  we write $\D v_1 \Doe \D v_2$.
\end{definition}

Using this relation, we can state a correct version of
\cref{thm:deriv-nil}:

\begin{lemma}[Behavior of derivatives on $\NILC$]
  \label{thm:deriv-nil-2}
  Given change structures $\ChangeStruct{A}$ and
  $\ChangeStruct{B}$, a function $f \in A \to B$, an element $a$
  of $A$, and the derivative $f'$ of $f$, we have
  $\App{\App{f'}{a}}{\NilC{a}} \Doe \NilC{\App* f a}$.
\end{lemma}

Moreover, we have a number of lemmas about change
equivalence.

% \pg{Revise statements for clarity.}

% \begin{lemma}[Change equivalence is an equivalence]
%   For any $x \in X$ with a change structure on $X$, change equivalence is an
%   equivalence relation (reflexive, symmetric, transitive) among
%   elements of $\Change{x}$.
% \end{lemma}

% \begin{lemma}[Identities using change equivalence]
%   Using change equivalence we can state additional algebraic equivalences,
%   that complement \cref{def:update-diff}.

% \begin{align*}
% \Update x \D{x} = x &\Leftrightarrow \D{x} \Doe \NilC{x}\\
% \Diff x x &\Doe \NilC {x}\\
% \Diff {\Update*{x}{\D{x}}} x &\Doe \D{x}
% \end{align*}
% \end{lemma}

\begin{lemma}[Function change application preserves change equivalence]
  For each $x \in X$, with a change structure on $X$, changes
  $\D{x}_1, \D{x}_2 \in \Change{x}$, for each $f \in X \to Y$,
with a change structure on $Y$, and changes
$\D{f}_1, \D{f}_2 \in \Change{f}$, then $\D{f}_1 \Doe \D{f}_2$ and
$\D{x}_1 \Doe \D{x}_2$ imply
$\D{f}_1~x~\D{x}_1 \Doe \D{f}_2~x~\D{x}_2$.
\end{lemma}
This lemma generalizes \cref{thm:deriv-respect-doe}.

That is, in all simple contexts that we can construct, two equivalent
changes will behave indistinguishably. In fact, for programs that
only use changes as changes (without looking at their
implementation details), we conjecture that equivalent changes are
observationally equivalent. However, making this conjecture
precise and proving it are efforts left for future work.

\begin{lemma}[Extensionality for change equivalence]
  If two function changes $\D{f}_1, \D{f}_2$ behave equally when
  applied to arbitrary type-correct inputs $x$,
  $\D{x}_1, \D{x}_2 \in \Change{x}$, then $\D{f}_1 \Doe \D{f}_2$.
\end{lemma}

\begin{lemma}[Derivatives are unique up to change equivalence]
  If two function changes $\D{f}_1, \D{f}_2$ are derivatives for
  $f$, then they're change equivalence to each other and to $f$'s nil change:
  $\D{f}_1 \Doe \NilC{f} \Doe \D{f}_2$.
\end{lemma}
We only have such an uniqueness theorem up to change equivalence, not to
standard equality, since multiple equivalent changes can be
different.
% XXX continue: Transcribe lemmas from Base.Change.Equivalence
